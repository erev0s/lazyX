#!/usr/bin/python

import os
import sys
import subprocess
import zipfile
import argparse


'''
lazyX is a small tool to automate the extraction, conversion of dex files
to jar files and decompiling of class files using dex2jar and cfr!


Adjust the following two lines to the directory of the dex2jar
and the Jar file of the cfr you have downloaded
'''
name_of_the_DEX2JAR_directory = "libs/dex-tools-2.2-SNAPSHOT"
name_of_the_cfr_jar = "libs/cfr-0.152.jar"
name_of_procyon_jar = "libs/procyon.jar"



cwd = os.path.dirname(os.path.realpath(__file__))
dexDir = cwd  + "/" + name_of_the_DEX2JAR_directory
cfrDir = cwd + "/" + name_of_the_cfr_jar
FNULL = open(os.devnull, 'w')


'''
Call the dex2jar on a dex file
'''
def dex2jar(dexDir, xpath, infile, outfile):
	subprocess.call(['sh', dexDir + "/d2j-dex2jar.sh", xpath + '/' + infile, '-o', xpath + '/' + outfile, '-f'])

'''
Call cfr on the jar file generated by dex2jar
'''
def cfr(dexDir, xpath, srcpath, jar):
	subprocess.call(['java','-Xms512m', '-Xmx1024m', '-jar', cfrDir, xpath + '/' + jar, '--outputdir', srcpath, '--silent', 'true', '--caseinsensitivefs', 'true'], stdout=FNULL)

'''
Call procyon on the jar file generated by dex2jar
'''
def procyon(dexDir, xpath, srcpath, jar):
	subprocess.call(['java','-Xms512m', '-Xmx1024m', '-jar', name_of_procyon_jar, xpath + '/' + jar, '-o', srcpath], stdout=FNULL, stderr=FNULL)


parser = argparse.ArgumentParser(description='Crack open an apk the lazy way. The tool supports CFR and Procyon decompilers.')
parser.add_argument('apkfile', help='your apk')
parser.add_argument('-d', help='Decompiler to be used. Options:[cfr, procyon]. If none is selected CFR is used. Example "-d cfr"')
args = parser.parse_args()
if not args.apkfile.endswith((".apk")):
	print("File is not an apk")
	sys.exit(0)

xpath = os.path.splitext(os.path.basename(args.apkfile))[0]
srcpath = xpath + "/src"


'''
Extract the apk
'''
try:
	zip_ref = zipfile.ZipFile(args.apkfile, 'r')
	zip_ref.extractall(xpath)
	zip_ref.close()
except IOError as e:
	print("Error extracting apk: " + str(e))
	sys.exit(0)


'''
Iterate over all the extracted files to find dex files
'''
for root, dirs, files in os.walk(xpath):
	for file in files:
		if file.endswith((".dex")):
			jar = os.path.splitext(file)[0] + ".jar"

			try:
				print("dex2jar ----> Converting...")
				dex2jar(dexDir, xpath, file, jar)
			except Exception as e:
				print('Something went wrong while DEX2JAR was converting! : '+ str(e))
				next
			if args.d == 'procyon':
				try:
					print("procyon ----> Decompiling...")

					procyon(dexDir, xpath, srcpath, jar)
				except Exception as e:
					print('Something went wrong while Procyon was decompiling! : ' + str(e))
			else:
				try:
					print("cfr ----> Decompiling...")

					cfr(dexDir, xpath, srcpath, jar)
				except Exception as e:
					print('Something went wrong while CFR was decompiling! : ' + str(e))

print("Completed!")
